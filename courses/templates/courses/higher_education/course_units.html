{% load wagtailcore_tags %}
<div class="scroll-m-8" id="course_units">
    <h2 class="text-xl lg:text-2xl mb-2 lg:mb-3 xl:mb-4 font-medium text-primary">Course Units</h2>
    <div x-data="{
        selectedCourse: 1,
        courseId: $id('course'),
        tabButtonClicked(tabButton) {
            this.selectedCourse = tabButton.id.replace(this.courseId + '-', '');
            this.tabRepositionMarker(tabButton);
        },
        tabRepositionMarker(tabButton) {
            this.$refs.tabMarker.style.width = tabButton.offsetWidth + 'px';
            this.$refs.tabMarker.style.height = tabButton.offsetHeight + 'px';
            this.$refs.tabMarker.style.left = tabButton.offsetLeft + 'px';
        },
        courseChanged(event) {
            this.selectedCourse = event.target.value;
        },
        courseContentActive(content) {
            return this.selectedCourse == content.id.replace(this.courseId + '-content-', '');
        }
    }" class="relative">

        {# Tabs for larger screens #}
        <div class="hidden xl:block">
            <div x-ref="tabButtons" class="relative inline-grid items-center justify-center w-full h-full p-1 text-gray-500 bg-white border border-gray-100 rounded-lg select-none" style="grid-template-columns: repeat({{ page.course_units|length }}, 1fr);">
                {% for block in page.course_units %}
                    <button 
                        :id="$id(courseId)" 
                        @click="tabButtonClicked($el)" 
                        type="button" 
                        :class="{ 'bg-gray-100 text-gray-700' : selectedCourse == {{ forloop.counter }} }" 
                        class="relative z-20 hidden xl:inline-flex items-center justify-center w-full px-1 py-2 h-full font-semibold text-primary transition-all rounded-md cursor-pointer 2xl:whitespace-nowrap"
                    >
                        {{ block.value.title }}
                    </button>
                {% endfor %}
                <div x-ref="tabMarker" class="absolute left-0 z-10 w-auto h-full duration-300 ease-out" x-cloak>
                    <div class="w-full h-full bg-gray-100 rounded-md shadow-sm"></div>
                </div>
            </div>
        </div>

        {# Select for smaller screens #}
        <div class="block xl:hidden z-10">
            <div class="relative flex w-full flex-col gap-1">
                <select 
                    x-model="selectedCourse"
                    @change="courseChanged($event)"
                    class="w-full appearance-none rounded-md border border-neutral-300 bg-neutral-50 px-2 text-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black"
                >
                    {% for block in page.course_units %}
                        <option value="{{ forloop.counter }}">{{ block.value.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        {# Content with Accordions #}
        <div class="mt-6">
            {% for block in page.course_units %}
                <div :id="$id(courseId + '-content')" x-show="courseContentActive($el)" class="relative" x-cloak>
                    <div x-data="{ 
                            activeAccordion: '', 
                            setActiveAccordion(id) { 
                                this.activeAccordion = (this.activeAccordion == id) ? '' : id 
                            } 
                        }" class="relative w-full mx-auto space-y-2">
                        {% if block.value.display_as_dropdown %}
                            {% for unit in block.value.units %}
                                <div 
                                    x-data="{ id: $id('accordion') }" 
                                    :class="{ 'border-primary text-neutral-800' : activeAccordion==id, 'text-gray-700' : activeAccordion!=id }" 
                                    class="duration-200 ease-out bg-white border rounded-md cursor-pointer group" 
                                    x-cloak
                                >
                                    <button 
                                        @click="setActiveAccordion(id)" 
                                        class="flex items-center justify-between w-full px-5 py-4 font-semibold text-left select-none group-hover:text-primary"
                                    >
                                        <span>{{ unit.unit_title }}</span>
                                        <div :class="{ 'rotate-90': activeAccordion==id }" class="relative flex items-center justify-center w-2.5 h-2.5 duration-300 ease-out">
                                            <div class="absolute w-0.5 h-full bg-neutral-500 group-hover:bg-primary rounded-full"></div>
                                            <div :class="{ 'rotate-90': activeAccordion==id }" class="absolute w-full h-0.5 ease duration-500 bg-neutral-500 group-hover:bg-primary rounded-full"></div>
                                        </div>
                                    </button>
                                    <div x-show="activeAccordion==id" x-collapse x-cloak>
                                        <div class="p-5 pt-0">
                                            {{ unit.unit_description|richtext }}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <ul class="flex flex-col w-full px-4 space-y-2 list-disc list-outside ml-5">
                                {% for unit in block.value.units %}
                                    <li class="font-semibold text-left">{{ unit.unit_title }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>